function getPixelAt(e,r){if(this.hasOwnProperty("pixels")&&this.width-1>=e&&e>0&&this.height-1>=r&&r>0){var t=r,o=this.width,f=o*t,i=f+e;return this.pixels[i]}}function setPixelAt(e,r,t){if(this.hasOwnProperty("pixels")&&this.width-1>=e&&e>0&&this.height-1>=r&&r>0&&t[0]>=0&&t[0]<=255&&t[1]>=0&&t[1]<=255&&t[2]>=0&&t[2]<=255&&t[3]>=0&&t[3]<=255){var o=r,f=this.width,i=f*o,a=i+e;this.pixels[a]=t;var n=new Buffer[4];n[0]=parseInt(t[2]).toString(16),n[1]=parseInt(t[1]).toString(16),n[2]=parseInt(t[0]).toString(16),n[3]=parseInt(t[3]).toString(16),this.pixelBuffers[a]=n}}function bitmapParser(e){if(Buffer.isBuffer(e)){var r={};if(r.buffer=e,r.osEndianness=os.endianness(),r.typeBuffer=r.buffer.slice(0,2),r.type=r.typeBuffer.toString("utf8"),"BM"!==r.type)return"Error: bitmapParser only parses BM type bitmaps.";if(r.sizeOfBitmapInBytesBuffer=r.buffer.slice(2,6),r.sizeOfBitmapInBytes=readUInt32OfBufferAt0(r.sizeOfBitmapInBytesBuffer),r.pixelOffsetInBytesBuffer=r.buffer.slice(10,14),r.pixelOffsetInBytes=readUInt32OfBufferAt0(r.pixelOffsetInBytesBuffer),r.dibHeaderSize=getDIBHeaderSize(r.buffer),r.dibHeaderType=getDIBHeaderType(r.dibHeaderSize),"BITMAPINFOHEADER"===r.dibHeaderType){r.widthBuffer=r.buffer.slice(18,22),r.width=readUInt32OfBufferAt0(r.widthBuffer),r.heightBuffer=r.buffer.slice(22,26),r.height=readUInt32OfBufferAt0(r.heightBuffer),r.numberOfColorPlanesBuffer=r.buffer.slice(26,28),r.numberOfColorPlanes=readUInt16OfBufferAt0(r.numberOfColorPlanesBuffer),r.colorDepthBuffer=r.buffer.slice(28,30),r.colorDepth=readUInt16OfBufferAt0(r.colorDepthBuffer),r.compressionMethodIndexBuffer=r.buffer.slice(30,34),r.compressionMethodIndex=readUInt32OfBufferAt0(r.compressionMethodIndexBuffer),r.compressionType=getCompressionType(r.compressionMethodIndex),r.rawDataSizeBuffer=r.buffer.slice(34,38),r.rawDataSize=readUInt32OfBufferAt0(r.rawDataSizeBuffer),r.horizontalResolutionBuffer=r.buffer.slice(38,42),r.horizontalResolution=readUInt32OfBufferAt0(r.horizontalResolutionBuffer),r.verticalResolutionBuffer=r.buffer.slice(42,46),r.verticalResolution=readUInt32OfBufferAt0(r.verticalResolutionBuffer),r.numberOfColorsInPaletteBuffer=r.buffer.slice(46,50),r.numberOfColorsInPalette=readUInt32OfBufferAt0(r.numberOfColorsInPaletteBuffer),r.numberOfImportantColorsBuffer=r.buffer.slice(50,54),r.numberOfImportantColors=readUInt32OfBufferAt0(r.numberOfImportantColorsBuffer);var t=0;for("BI_BITFIELDS"===r.compressionType&&(r.redBitMaskBuffer=r.buffer.slice(54,58),r.greenBitMaskBuffer=r.buffer.slice(58,62),r.blueBitMaskBuffer=r.buffer.slice(62,66),t=12),r.colorPaletteBuffer=r.buffer.slice(14+r.dibHeaderSize+t,r.pixelOffsetInBytes),r.colorPalettePixels=[],r.colorPalettePixelBuffers=[],i=0;i<r.pixelOffsetInBytes-(14+r.dibHeaderSize+t);i+=4){var o=r.colorPaletteBuffer.slice(i,i+1),f=r.colorPaletteBuffer.slice(i+1,i+2),a=r.colorPaletteBuffer.slice(i+2,i+3),n=r.colorPaletteBuffer.slice(i+3,i+4),s=a.readUInt8(0),l=f.readUInt8(0),u=o.readUInt8(0),p=n.readUInt8(0),d=[a,f,o,n],c=[s,l,u,p];r.colorPalettePixels.push(c),r.colorPalettePixelBuffers.push(d)}r.pixels=[],r.pixelBuffers=[];var B=0,h=1;for(0===r.colorPalettePixels.length&&(24===r.colorDepth?h=3:32===r.colorDepth&&(h=4)),i=r.pixelOffsetInBytes;i<r.width*r.height*h+r.pixelOffsetInBytes;i++){var s,l,u,p;if(r.colorPalettePixels.length>0&&8===r.colorDepth){var m=r.buffer.slice(i,i+1),b=m.readUInt8(0);s=r.colorPalettePixels[b][0],l=r.colorPalettePixels[b][1],u=r.colorPalettePixels[b][2],p=r.colorPalettePixels[b][3]}else if(24===r.colorDepth&&B<=r.width*r.height*h){var m=r.buffer.slice(i,i+3);s=m.readUInt8(2),l=m.readUInt8(1),u=m.readUInt8(0),p=0,i+=2,B++}if(B<=r.width*r.height){var c=[s,l,u,p];r.pixels.push(c),r.pixelBuffers.push(m)}}}else if("BITMAPV4HEADER"===r.dibHeaderType){r.widthBuffer=r.buffer.slice(18,22),r.width=readUInt32OfBufferAt0(r.widthBuffer),r.heightBuffer=r.buffer.slice(22,26),r.height=readUInt32OfBufferAt0(r.heightBuffer),r.numberOfColorPlanesBuffer=r.buffer.slice(26,28),r.numberOfColorPlanes=readUInt16OfBufferAt0(r.numberOfColorPlanesBuffer),r.colorDepthBuffer=r.buffer.slice(28,30),r.colorDepth=readUInt16OfBufferAt0(r.colorDepthBuffer),r.compressionMethodIndexBuffer=r.buffer.slice(30,34),r.compressionMethodIndex=readUInt32OfBufferAt0(r.compressionMethodIndexBuffer),r.compressionType=getCompressionType(r.compressionMethodIndex),r.rawDataSizeBuffer=r.buffer.slice(34,38),r.rawDataSize=readUInt32OfBufferAt0(r.rawDataSizeBuffer),r.horizontalResolutionBuffer=r.buffer.slice(38,42),r.horizontalResolution=readUInt32OfBufferAt0(r.horizontalResolutionBuffer),r.verticalResolutionBuffer=r.buffer.slice(42,46),r.verticalResolution=readUInt32OfBufferAt0(r.verticalResolutionBuffer),r.numberOfColorsInPaletteBuffer=r.buffer.slice(46,50),r.numberOfColorsInPalette=readUInt32OfBufferAt0(r.numberOfColorsInPaletteBuffer),r.numberOfImportantColorsBuffer=r.buffer.slice(50,54),r.numberOfImportantColors=readUInt32OfBufferAt0(r.numberOfImportantColorsBuffer),r.redMaskBuffer=r.buffer.slice(54,58),r.redMask=readUInt32OfBufferAt0(r.redMaskBuffer),r.greenMaskBuffer=r.buffer.slice(58,62),r.greenMask=readUInt32OfBufferAt0(r.greenMaskBuffer),r.blueMaskBuffer=r.buffer.slice(62,66),r.blueMask=readUInt32OfBufferAt0(r.blueMaskBuffer),r.alphaMaskBuffer=r.buffer.slice(66,70),r.alphaMask=readUInt32OfBufferAt0(r.alphaMaskBuffer),r.colorSpaceTypeBuffer=r.buffer.slice(70,74),r.colorSpaceType=readUInt32OfBufferAt0(r.colorSpaceTypeBuffer),r.cieXYZBuffer=r.buffer.slice(74,110);var I=r.cieXYZBuffer.slice(0,12),P=I.slice(0,4),O=I.slice(4,8),g=I.slice(8,12),y=[readUInt32OfBufferAt0(P),readUInt32OfBufferAt0(O),readUInt32OfBufferAt0(g)],x=r.cieXYZBuffer.slice(12,24),w=x.slice(0,4),U=x.slice(4,8),A=x.slice(8,12),S=[readUInt32OfBufferAt0(w),readUInt32OfBufferAt0(U),readUInt32OfBufferAt0(A)],v=r.cieXYZBuffer.slice(24,36),z=v.slice(0,4),H=v.slice(4,8),M=v.slice(8,12),E=[readUInt32OfBufferAt0(z),readUInt32OfBufferAt0(H),readUInt32OfBufferAt0(M)];for(r.cieXYZ=[y,S,E],r.redGammaBuffer=r.buffer.slice(110,114),r.redGamma=readUInt32OfBufferAt0(r.redGammaBuffer),r.greenGammaBuffer=r.buffer.slice(114,118),r.greenGamma=readUInt32OfBufferAt0(r.greenGammaBuffer),r.blueGammaBuffer=r.buffer.slice(118,122),r.blueGamma=readUInt32OfBufferAt0(r.blueGammaBuffer),r.colorPaletteBuffer=r.buffer.slice(14+r.dibHeaderSize,r.pixelOffsetInBytes),r.colorPalettePixels=[],r.colorPalettePixelBuffers=[],i=0;i<r.pixelOffsetInBytes-(14+r.dibHeaderSize);i+=4){var o=r.colorPaletteBuffer.slice(i,i+1),f=r.colorPaletteBuffer.slice(i+1,i+2),a=r.colorPaletteBuffer.slice(i+2,i+3),n=r.colorPaletteBuffer.slice(i+3,i+4),s=a.readUInt8(0),l=f.readUInt8(0),u=o.readUInt8(0),p=n.readUInt8(0),d=[a,f,o,n],c=[s,l,u,p];r.colorPalettePixels.push(c),r.colorPalettePixelBuffers.push(d)}r.pixels=[],r.pixelBuffers=[];var B=0,h=1;for(0===r.colorPalettePixels.length&&(24===r.colorDepth?h=3:32===r.colorDepth&&(h=4)),i=r.pixelOffsetInBytes;i<r.width*r.height*h+r.pixelOffsetInBytes;i++){var s,l,u,p;if(r.colorPalettePixels.length>0&&8===r.colorDepth){var m=r.buffer.slice(i,i+1),b=m.readUInt8(0);s=r.colorPalettePixels[b][0],l=r.colorPalettePixels[b][1],u=r.colorPalettePixels[b][2],p=r.colorPalettePixels[b][3]}else if(24===r.colorDepth&&B<=r.width*r.height*h){var m=r.buffer.slice(i,i+3);s=m.readUInt8(2),l=m.readUInt8(1),u=m.readUInt8(0),p=0,i+=2,B++}if(B<=r.width*r.height){var c=[s,l,u,p];r.pixels.push(c),r.pixelBuffers.push(m)}}}return consoleLogParsedData(r),r}return void 0===e?"Error: bitmapParser has not been provided a [bitmapBuffer].  [bitmapBuffer] must be a buffer provided to the function.":"Error: bitmapParser has been provided an invalid [bitmapBuffer].  [bitmapBuffer] must be a buffer."}function readUInt32OfBufferAt0(e){var r=-1;return r="LE"===endianness?e.readUInt32LE(0):e.readUInt32BE(0)}function readUInt16OfBufferAt0(e){var r=-1;return r="LE"===endianness?e.readUInt16LE(0):e.readUInt16BE(0)}function getDIBHeaderSize(e){var r=-1;return r="LE"===endianness?e.readUInt32LE(14):e.readUInt32BE(14)}function getDIBHeaderType(e){var r="Error: Bitmap DIB header is not a standard format.";return 12===e?r="BITMAPCOREHEADEROS21XBITMAPHEADER":40===e?r="BITMAPINFOHEADER":52===e?r="BITMAPV2INFOHEADER":56===e?r="BITMAPV3INFOHEADER":64===e?r="OS22XBITMAPHEADER":108===e?r="BITMAPV4HEADER":124===e&&(r="BITMAPV5HEADER"),r}function getCompressionType(e){var r="Error: The compression method index provided does not correspond to a standard compression type.";return 0===e?r="BI_RGB":1===e?r="BI_RLE8":2===e?r="BI_RLE4":3===e?r="BI_BITFIELDS":4===e?r="BI_JPEG":5===e?r="BI_PNG":6===e?r="BI_ALPHABITFIELDS":11===e?r="BI_CMYK":12===e?r="BI_CMYKRLE8":13===e&&(r="BI_CMYKRLE4"),r}function consoleLogParsedData(e){e.hasOwnProperty("osEndianness")&&console.log("Operating system endianness: "+e.osEndianness),e.hasOwnProperty("type")&&console.log("Bitmap type: "+e.type),e.hasOwnProperty("sizeOfBitmapInBytes")&&console.log("Size of the bitmap in bytes: "+e.sizeOfBitmapInBytes),e.hasOwnProperty("pixelOffsetInBytes")&&console.log("Pixel offset in bytes: "+e.pixelOffsetInBytes),e.hasOwnProperty("dibHeaderSize")&&console.log("DIB header size: "+e.dibHeaderSize),e.hasOwnProperty("dibHeaderType")&&console.log("DIB header type: "+e.dibHeaderType),e.hasOwnProperty("width")&&console.log("Width: "+e.width),e.hasOwnProperty("height")&&console.log("Height: "+e.height),e.hasOwnProperty("numberOfColorPlanes")&&console.log("Number of color planes:"+e.numberOfColorPlanes),e.hasOwnProperty("colorDepth")&&console.log("Color depth: "+e.colorDepth),e.hasOwnProperty("compressionMethodIndex")&&console.log("Compression method index: "+e.compressionMethodIndex),e.hasOwnProperty("compressionType")&&console.log("Compression type: "+e.compressionType),e.hasOwnProperty("rawDataSize")&&console.log("Raw data size: "+e.rawDataSize),e.hasOwnProperty("horizontalResolution")&&console.log("Horizontal resolution: "+e.horizontalResolution),e.hasOwnProperty("verticalResolution")&&console.log("Vertical resolution: "+e.verticalResolution),e.hasOwnProperty("numberOfColorsInPalette")&&console.log("Number of colors in palette: "+e.numberOfColorsInPalette),e.hasOwnProperty("numberOfImportantColors")&&console.log("Number of important colors: "+e.numberOfImportantColors),e.hasOwnProperty("colorPalettePixels")&&console.log("Color palette pixels array length: "+e.colorPalettePixels.length),e.hasOwnProperty("pixels")&&console.log("Pixels array length: "+e.pixels.length),e.hasOwnProperty("redMask")&&console.log("Red mask: "+e.redMask),e.hasOwnProperty("greenMask")&&console.log("Green mask: "+e.greenMask),e.hasOwnProperty("blueMask")&&console.log("Blue mask: "+e.blueMask),e.hasOwnProperty("alphaMask")&&console.log("Alpha mask: "+e.alphaMask),e.hasOwnProperty("colorSpaceType")&&console.log("Color space type: "+e.colorSpaceType),e.hasOwnProperty("cieXYZ")&&console.log("CIEXYZ triplet: "+e.cieXYZ),e.hasOwnProperty("redGamma")&&console.log("Red gamma: "+e.redGamma),e.hasOwnProperty("greenGamma")&&console.log("Green gamma: "+e.greenGamma),e.hasOwnProperty("blueGamma")&&console.log("Blue gamma: "+e.blueGamma)}function readBitmap(e){fs.readFile(e,function(e,r){return e?console.log(e):(getHeadInfo(r),void transform(r))})}function getHeadInfo(e){var r={};return r.type=e.toString("utf8",0,2),r.size=e.readUInt32LE(2),r.pixels=e.readUInt32LE(10),r.palette=e.readUInt32LE(46),r.someColors=e.toString("utf8",54,94),console.log(r),r}function transform(e){for(var r=[],t=0;t<e.length;t++)e[t]=e.readUInt8(t),r.push(e[t]);for(var o=54;o<r.length;o++)r[o]%2&&(r[o]=Math.floor(255*Math.random())),r[o]=r[o]/2;newBitmap(r)}function makeNew(e){var r=new Buffer(e);fs.writeFile("new_bitmap.bmp",r,function(e){return e?console.log(e):void console.log("Success, your file has been created!")})}var fs=require("fs"),Buffer=require("buffer").Buffer,bitmapParser=require(__dirname+"/bitmapParser.js").bitmapParser,Bitmap=function(e){var r=this;fs.readFile(e,function(e,t){if(e)return console.log(e);var o=bitmapParser(t);r.writeBitmap(o.buffer)})};Bitmap.prototype.writeBitmap=function(e){fs.writeFile("new_bitmap.bmp",e,function(e){return e?console.log(e):void console.log("Success, your file has been created!")})},Bitmap.prototype.transformPaletteToGreyscale=function(e){if(e.hasOwnProperty("numberOfColorsInPalette"))if(e.numberOfColorsInPalette>0){if(e.hasOwnProperty("colorPalettePixels"))for(i=0;i<e.pixelOffsetInBytes-(14+e.dibHeaderSize);i+=4){e.colorPaletteBuffer=e.buffer.slice(14+e.dibHeaderSize,e.pixelOffsetInBytes);var r=e.colorPaletteBuffer.slice(i,i+1),t=e.colorPaletteBuffer.slice(i+1,i+2),o=e.colorPaletteBuffer.slice(i+2,i+3),f=e.colorPaletteBuffer.slice(i+3,i+4),a=o.readUInt8(0),n=t.readUInt8(0),s=r.readUInt8(0),l=f.readUInt8(0),u=Math.floor((a+n+s+l)/3);e.buffer[14+e.dibHeaderSize+i]=u.toString(16),e.buffer[14+e.dibHeaderSize+i+1]=u.toString(16),e.buffer[14+e.dibHeaderSize+i+2]=u.toString(16),e.buffer[14+e.dibHeaderSize+i+3]=u.toString(16)}}else console.log("This bitmap does not have a palette to transform.");else console.log("This bitmap does not have a defined number of palette colors.  You cannot transform the color palette until it has been fully initialized within the Bitmap object.")},Bitmap.prototype.transformPaletteToRedChannel=function(e){if(e.hasOwnProperty("numberOfColorsInPalette"))if(e.numberOfColorsInPalette>0){if(e.hasOwnProperty("colorPalettePixels"))for(i=0;i<e.pixelOffsetInBytes-(14+e.dibHeaderSize);i+=4)e.colorPaletteBuffer=e.buffer.slice(14+e.dibHeaderSize,e.pixelOffsetInBytes),e.buffer[14+e.dibHeaderSize+i]=parseInt(0).toString(16),e.buffer[14+e.dibHeaderSize+i+1]=parseInt(0).toString(16)}else console.log("This bitmap does not have a palette to transform.");else console.log("This bitmap does not have a defined number of palette colors.  You cannot transform the color palette until it has been fully initialized within the Bitmap object.")},Bitmap.prototype.transformPaletteToBlueChannel=function(e){if(e.hasOwnProperty("numberOfColorsInPalette"))if(e.numberOfColorsInPalette>0){if(e.hasOwnProperty("colorPalettePixels"))for(i=0;i<e.pixelOffsetInBytes-(14+e.dibHeaderSize);i+=4)e.colorPaletteBuffer=e.buffer.slice(14+e.dibHeaderSize,e.pixelOffsetInBytes),e.buffer[14+e.dibHeaderSize+i+1]=parseInt(0).toString(16),e.buffer[14+e.dibHeaderSize+i+2]=parseInt(0).toString(16)}else console.log("This bitmap does not have a palette to transform.");else console.log("This bitmap does not have a defined number of palette colors.  You cannot transform the color palette until it has been fully initialized within the Bitmap object.")},Bitmap.prototype.transformPaletteToGreenChannel=function(e){if(e.hasOwnProperty("numberOfColorsInPalette"))if(e.numberOfColorsInPalette>0){if(e.hasOwnProperty("colorPalettePixels"))for(i=0;i<e.pixelOffsetInBytes-(14+e.dibHeaderSize);i+=4)e.colorPaletteBuffer=e.buffer.slice(14+e.dibHeaderSize,e.pixelOffsetInBytes),e.buffer[14+e.dibHeaderSize+i]=parseInt(0).toString(16),e.buffer[14+e.dibHeaderSize+i+2]=parseInt(0).toString(16)}else console.log("This bitmap does not have a palette to transform.");else console.log("This bitmap does not have a defined number of palette colors.  You cannot transform the color palette until it has been fully initialized within the Bitmap object.")},exports.Bitmap=Bitmap;var os=require("os"),endianness=os.endianness();exports.bitmapParser=bitmapParser;var fs=require("fs"),transform=require(__dirname+"/transform").transform;exports.readBitmap=readBitmap,exports.getHeadInfo=getHeadInfo;var readBitmap=require(__dirname+"/bitmap_data_reader.js"),newBitmap=require(__dirname+"/write_new_bitmap.js").makeNew;exports.transform=transform;var fs=require("fs"),transform=require(__dirname+"/transform.js").transform;exports.makeNew=makeNew;